---
title: "ENTREGA PC4-2 BAJO PESO"
format: html
editor: visual
---

# Introducción:

-   En este documento realizaremos el proceso completo de imputación de datos faltantes utilizando el paquete \`mice\` en R, aplicado al conjunto de datos de bajo peso al nacer.

-   El objetivo es demostrar cómo manejar la incertidumbre de los datos perdidos para evitar sesgos en nuestros análisis (como la eliminación de casos completos) y obtener estimaciones más robustas en nuestros modelos de regresión.

# **1. Instalación y carga de paquetes:**

```{r}
#| message: false
#| warning: false
if (!require("mice")) install.packages("mice")
if (!require("ggmice")) install.packages("ggmice")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("rio")) install.packages("rio")
if (!require("gtsummary")) install.packages("gtsummary")
if (!require("here")) install.packages("here")

library(mice)
library(tidyverse)
library(here)
library(rio)
library(ggmice)
library(gtsummary)
```

# 2. Cargar los datos

Cargamos el dataset `bajo_peso.csv`. Asegúrate de que el archivo esté en tu carpeta de trabajo o ajusta la ruta.

```{r}

# Cargar los datos
bajo_peso <- read_csv("C:/Users/Franco Rodrigo/Desktop/DATA/bajo_peso.csv")

# vistazo de los datos:

head(bajo_peso)
glimpse(bajo_peso) 

bajo_peso <- import(here("data", "bajo_peso.csv"))

# Convertir variables categóricas a factor
bajo_peso <- bajo_peso %>%
  mutate(
    bajo_peso = factor(bajo_peso, levels = c("No", "Sí"), labels = c("No", "Sí")),
    raza = factor(raza),
    fuma = factor(fuma, levels = c("No", "Sí")),
    hipertension = factor(hipertension, levels = c("No", "Sí")),
    irritabilidad_utero = factor(irritabilidad_utero, levels = c("No", "Sí"))
  )

glimpse(bajo_peso)
```

# 3. Preparación de datos y Generación de Valores Perdidos

**¿Qué hacemos?** Contamos cuántos valores faltan por variable y visualizamos los patrones de missingness.

**¿Por qué es importante?**

-   Conocer el alcance del problema (¿poco o mucho missing?).

-   Identificar si existen patrones sistemáticos (ej. madres jóvenes tienen más missing en visitas prenatales).

-   Decidir si la imputación es factible y cuál será la estrategia más adecuada.

```{r}
# Diagnóstico de datos perdidos
colSums(is.na(bajo_peso))
```

# Mapa de calor de patrones de datos perdidos

```{r}
# Mapa de calor de patrones de datos perdidos
bajo_peso %>%
  select(bajo_peso, edad_madre, peso_madre, raza, fuma, partos_prematuros,
         hipertension, irritabilidad_utero, visitas_medicas, peso_nacer) %>%
  ggmice::plot_pattern(square = TRUE, rotate = TRUE) +
  labs(title = "Patrón de datos perdidos en el dataset Bajo Peso al Nacer")
```

# 4. ¿Los datos perdidos son completamente al azar (MCAR)?

**¿Qué hacemos?** Comparamos las características de las madres con y sin datos perdidos en las dos variables con más missing: peso_madre y peso_nacer.

**¿Por qué es crucial?** Si los grupos difieren sistemáticamente → los datos son **MAR** (missing at random) o incluso **MNAR**. En ambos casos, el análisis de casos completos estaría sesgado. Esta tabla nos da la evidencia para justificar la imputación.

Compararemos las características de las madres según tengan o no datos perdidos en las dos variables con mayor cantidad de missing: peso_madre y peso_nacer.

```{r}
tabla_peso_madre <- bajo_peso %>%
  mutate(missing = is.na(peso_madre)) %>%
  select(-peso_nacer) %>%
  tbl_summary(by = missing,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              missing_text = "Datos perdidos") %>%
  add_n() %>%
  modify_header(label = "**Variable**") %>%
  bold_labels()

tabla_peso_nacer <- bajo_peso %>%
  mutate(missing = is.na(peso_nacer)) %>%
  select(-peso_madre) %>%
  tbl_summary(by = missing,
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              missing_text = "Datos perdidos") %>%
  add_n() %>%
  modify_header(label = "**Variable**") %>%
  bold_labels()

tbl_merge(list(tabla_peso_madre, tabla_peso_nacer),
          tab_spanner = c("**Peso madre perdido**", "**Peso al nacer perdido**"))
```

**Conclusión:** Existen diferencias importantes → los datos no son MCAR → eliminar casos completos introduciría sesgo → imputación múltiple es necesaria.

# 5. Preparación para la imputación

**¿Qué hacemos?** Seleccionamos todas las variables que aparecerán en el modelo final (incluyendo la variable dependiente bajo_peso).

**¿Por qué?** El modelo de imputación debe ser **al menos tan complejo** como el modelo de análisis final (regla de Rubin). Incluir todas las variables garantiza que la información auxiliar mejore la calidad de los valores imputados.

Incluimos todas las variables que usaremos en el análisis final (incluyendo la variable outcome).

```{r}
# preparación de datos:
datos_imp <- bajo_peso %>%
  select(bajo_peso, edad_madre, peso_madre, raza, fuma,
         partos_prematuros, hipertension, irritabilidad_utero,
         visitas_medicas, peso_nacer) %>%
  mutate(across(where(is.character), as.factor))
```

# 5. Imputación múltiple con MICE

**Usaremos:**

-   20 imputaciones (m = 20)

-   Predictive Mean Matching (pmm) para variables continuas

-   Regresión logística (logreg) para variables binarias

-   Regresión logística multinomial (polyreg) para raza

```{r}
set.seed(2025)  # reproducibilidad

imp <- mice(datos_imp,
            m = 20,
            maxit = 30,
            method = c("logreg",   # bajo_peso (binaria)
                       "pmm",      # edad_madre
                       "pmm",      # peso_madre
                       "polyreg",  # raza (3 niveles)
                       "logreg",   # fuma
                       "pmm",      # partos_prematuros
                       "logreg",   # hipertension
                       "logreg",   # irritabilidad_utero
                       "pmm",      # visitas_medicas
                       "pmm"),     # peso_nacer
            seed = 2025,
            printFlag = FALSE)

imp
```

# 6. Validación de la imputación

# 6.1 Distribución de valores imputados vs observados (variables continuas)

**¿Qué hacemos?** Graficamos la distribución de los 20 conjuntos imputados frente a los datos observados.

**¿Por qué?** Queremos confirmar que los valores imputados no son extremos ni violan las distribuciones biológicas reales (ej. nadie pesa 20 kg o 300 kg).

```{r}
# Peso de la madre
ggmice(imp, aes(x = .imp, y = peso_madre)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +
  labs(title = "Distribución imputada vs observada: Peso de la madre (libras)",
       x = "Número de imputación (0 = datos observados)")

# Peso al nacer
ggmice(imp, aes(x = .imp, y = peso_nacer)) +
  geom_boxplot(alpha = 0.7, outlier.shape = NA) +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +
  +
  labs(title = "Distribución imputada vs observada: Peso al nacer (gramos)",
       x = "Número de imputación (0 = datos observados)")
```

Los valores imputados son muy plausibles y se solapan correctamente con los observados.

# 6.2 Variable categórica: ¿se preservan las proporciones?

**¿Qué hacemos?** Comparamos la prevalencia de bajo peso en datos observados vs. imputados.

**¿Por qué?** Un cambio importante en las proporciones indicaría un problema grave en la imputación.

```{r}
datos_long <- complete(imp, "long", include = TRUE) %>%
  mutate(imputado = .imp > 0,
         imputado = factor(imputado, labels = c("Observado", "Imputado")))

# Proporciones de bajo peso
prop.table(table(datos_long$bajo_peso, datos_long$imputado), margin = 2) %>%
  round(3)
```

# 7. Modelo final: Factores asociados al bajo peso al nacer

**¿Qué hacemos?** Ajustamos una regresión logística multivariada en cada uno de los 20 conjuntos imputados y combinamos los resultados usando las reglas de Rubin (función pool internamente manejada por gtsummary).

**¿Por qué?** Esto proporciona estimaciones no sesgadas, intervalos de confianza correctos y valores p válidos incluso con datos perdidos.

Regresión logística multivariada con pooling automático (reglas de Rubin) usando gtsummary.

```{r}  # preparación de datos: datos_imp <- bajo_peso %>%   select(bajo_peso, edad_madre, peso_madre, raza, fuma,          partos_prematuros, hipertension, irritabilidad_utero,          visitas_medicas, peso_nacer) %>%   mutate(across(where(is.character), as.factor))}
```

## Conclusiones

-   Se realizó una imputación múltiple de alta calidad en el dataset bajo_peso.csv.

-   Los valores imputados son plausibles y respetan las distribuciones originales.

-   El modelo final combina correctamente las 20 imputaciones y permite obtener estimaciones válidas de odds ratios ajustados y sus intervalos de confianza.

Este documento es completamente reproducible y sigue las mejores prácticas actuales en análisis con datos perdidos en investigación perinatal.
